# 序言

在项目或者课题中经常会用到编程技能，用于解决一些特定的问题或者帮助实现具体的想法。程序或软件的构建往往并不只是单人活动，程序也不是写完就可以不用回顾，做好代码的维护、管理、与他人协作等和写代码本身一样重要。高可读性、易维护性、低出错率、方便与他人的合作等是好代码的必备条件。

从程序构建的角度来讲，一个整体架构上的平衡将使得复杂的程序更具秩序，复杂整体中的每个细节都能在这个统一的框架下发挥作用。统一的规则减少了因为不同部分采取了不同的编程风格而产生的混乱与割裂。同时要明确，写代码首先写给人看，其次才是机器。

但是由于每个人学习的路线不尽相同，同时每个人在初期都形成了自己的一套习惯，这给代码的后期维护和管理，组内成员的交流、构建可重复使用的程序等造成了一定的困难。因此，为解决上述问题，有必要根据软件开发实践方面的资料[@anayaBianXieZheng2022; @martinDaiMaZheng2010; @mcconnellDaiMaDa2006; @PEP8Python]、组内的编程风格及相关的专业知识编写出一套约束规范。

课题组的开发重点在后端，如模型的开发，底层逻辑的实现，算法的实现等。实际上代码的规范约定是一个比较通用的概念，对于代码开发的具体环节和部分并没有十分清晰的划分，重点是建立规范，而不是深究细节。而前端后端的主要区分在于使用的编程语言不同，对于课题组所使用的Python，本文也给出了相关的规范与要求。本文所介绍的大多数代码规范可大致分为基本原则和具体实施两部分；同时按照编程活动可分为以下几个方面：

- 变量规范
- 子程序规范
- 类规范
- 格式或布局规范
- 注释规范

# 变量的规范

变量是编程活动中非常常见的一个概念，但是变量的使用、命名等方面上存在许多有待规范和统一的细节。

## 变量规范的基本原则

### 缩小变量的作用域

作用域形容一个变量的可见的程度，体现了它在多大的范围内起作用，可以从跨度和存活时间两个指标去衡量：

- 跨度形容的是引用变量的集中程度
- 存活时间丈量的是代码的第一次引用到最后一次引用跨过的代码篇幅或语句数量

尽可能缩小变量的作用域，有利于降低出错率，方便使用者查阅代码、追溯变量和管理代码，增强可读性，方便后期划分为新的独立子程序具体的实施可遵循以下几点：

- 遵循就近原则：变量声明的同时初始化，用到变量的时候再去考虑初始化和赋值，尽量是在靠近第一次使用变量的地方。
- 相关语句成组，尤其是用到同一个变量的多个语句。相关的语句还可以提取成单独的子程序以进一步减小变量的作用域
- 尽量局部化，少用全局变量

### 变量被赋具体值时间点越晚越好

将变量和值绑定在一起的时间点越晚，程序的灵活性就越高，一旦这里的值有变化，就不用在程序中多处修改类似的地方，而只需要修改数据的来源即可，但过度的灵活性会使程序更加复杂。

技巧：使用具名常量而不是某个数值。

### 为变量指定单一用途

变量和用途之间秉持一对一的原则：在一个程序中不要让同一个名字的变量同时负责多个功能，这样可能会使没有关联的两段程序看似产生了“关联”，降低了可读性，尝试通过让变量的名称含义更加具体，更加接近要描述的事物。反过来，也要注意尽可能使用到所有已声明的变量，不要声明了但不使用。

避免让变量有隐含的含义，例如用-1表示错误，这是用整型数据去代表布尔型数据，多出的这一类信息用另一个变量去表示。

### 变量的命名完全且准确地描述代表的事物

变量名包含三类信息：

- 变量的内容：表示什么
- 数据的类型：具名常量，简单变量等
- 变量的作用域：全局、类内部等

好的变量名能够清楚地表示出上边三类信息，读变量名就知道它所表示的是什么，而不是要干什么。避免 `x`、`y`、`current` 这种表述不清变量具体代表的是什么的名称，这样做不利于读懂变量的含义，如果一段代码需要让人去猜测含义的时候，有可能就是变量的命名出了问题。

对于不同类型的变量，总体上仍遵循好的变量名要完全且准确地描述出该变量代表的事物这一原则：

- 循环变量：一旦在循环外使用到，就不要命名成i、j、k等
- 状态变量：最好表示出什么的状态，而不是只用“状态”（flag）这种，同样状态后边对应的具体值也可以用具名常量或者枚举以表达出更清晰的含义
- 临时变量：要尽可能弄懂它的具体含义，不要用一个“临时”（`temp`）含糊过去
- 布尔变量：使用典型的诸如done、error、found、success、ok等这种本身就包含是否含义的名字，不要加否定词

采取一定的命名规则对不同类型的数据或程序给出区分，例如大小写，前缀后缀等，根据课题组所使用的语言，具体可参考后续2.2节Python命名规范。以下是列出的几个需要区分的点：

- 变量名和子程序名作出区分
- 区分类和对象
- 区分出全局变量
- 区分出成员变量
- 区分出类型声明
- 区分出具名常量
- 区分出枚举
- 格式化：分隔符或大小写

变量名中的计算值限定词放在后边：把最大、最小、总和、平均这些词统一放在变量名字的后边，将有含义、比较重要的部分放在前边。

如涉及到对仗词，使用约定好的、易理解的、保持一致的一组相反词：如 `open/close`、`min/max`、`old/new` 等。

### 变量名的长度

变量命名的最佳长度在9～15个字符。但这不是很强硬的规定，只是需要注意当有很多变量名都不太符合这个长度时，有可能需要重新检查一下这些变量的名称是不是表示出了清晰的含义，或者过长导致不易读。合理的变量名长度是规范清晰的变量命名的结果。

变量的长度和作用域呈正相关。比较长的名字适合那些用的很少的变量或者全局变量，而那些很短的名字所代表的变量的作用域很小，例如循环变量 `i`。

## Python命名规范

更具体的命名规范可参照PEP-8[@PEP8Python]，以下列几点：

- 包和模块使用简短小写的命名，包的命名中下划线尽量不要加：`numpy`
- 类命名使用驼峰命名法：`UpperCameCase`
- 子程序（函数和方法）和变量使用蛇形命名法：`lowercase_with_underscores`
- 常量全大写字母加下划线分隔：`MAX_OVERFLOW`
- 非公开的部分在前边加一个下划线区分：`_private_var`
- “I、l、O”这些和“1、0”难以区分，不要用作单字符变量名

## 课题组变量命名约定清单

# 子程序的规范

子程序是一个大型程序中的某部分代码，由一个或多个语句块组成。它负责完成某项特定任务，而且相较于其他代码，具备相对的独立性[@ZiChengXu2024]。构建良好的子程序有助于大型代码的维护和管理。一般来讲子程序包括函数和过程两种，在Python中指的是函数，如果是类或实例当中，指的应该是方法。

子程序的命名和它所负责的事情有关，因此子程序命名困难或参数太多可能是因为子程序本身设计有问题。

## 子程序规范的基本原则

### 子程序的命名

子程序的命名要清晰表达做了什么描述出子程序做的所有事情，而不要只谈其一避开其二，避免笼统、模糊的表达，含义要具体、准确、尽量没有歧义。如果包含的操作太多，或者本身所做的事情就模糊不清，就难以做到在完整清晰地描述子程序的作用的前提下控制住名字的长度，这是子程序本身设计的问题，应该着手程序的重新设计和组织，而不是牺牲子程序名字良好的描述性来应付过去。

另外，不使用数字，数字表达不出子程序的作用。

对于不同类型的子程序，其特点和作用也要在命名上有所体现：

- 函数的命名要对返回值有所描述
- 过程则是强调动词和宾语（面向对象语言中无需加宾语，因为已经在对象的调用语句中体现，再加宾语会重复）

### 子程序的长度问题

对于过长（超过200行）的子程序保持谨慎，因为统计数据表明超过200行的子程序容易出错，成本偏高，可读性也不强。但是更重要的是把关注点放在影响子程序长短的那些因素上，如内聚性、嵌套层次、变量的数量、注释数量等，而不要刻意限制子程序的长度

子程序命名的合适长度与变量的命名长度类似——9～15个字符。由于通常来讲子程序比一个变量要复杂，因此相应项命名长度可能也会长一点，但总体不脱离“子程序命名应以清晰表达为主”这一大前提。

### 子程序的参数的顺序和数量问题

子程序的参数要考虑既定的顺序。按照按照输入-修改-输出的顺序排列参数，这样和子程序内部所包含的操作能有所对应，注意如果多个子程序使用类似的参数，则让它们的顺序保持一致以便记忆，如果有状态或出错变量（不是程序的主要功能），应该放在最后边。另外，如果认为输入、修改、输出参数的区分比较重要，可以考虑在它们的命名中加入相应的前缀，当然前提是遵循统一的命名规则。

子程序参数的数量限制在约7个以内。太多的参数记忆和理解比较困难，同样这也暗含了设计问题：需要传递太多的参数也可能是因为子程序之间的耦合太强，应考虑重新设计或组织。

### 子程序的接口和参数

在接口中对参数的前提或某些约束加以说明，当参数有某些特征，对这些假定要予以说明，在Python中，使用合适的文档字符串和注解进行说明，无需另加注释。例如：

- 输入/修改/输出
- 参数的单位
- 状态代码或错误值的含义（0、1代表什么？）
- 所能接受的数值范围
- 某些不合理的特定数值

输入参数不能作为子程序中使用的工作变量，传入子程序的参数是不能在子程序中随意修改的，这样做会导致实际代表的含义和最初的变量名称不相匹配，会导致不必要的麻烦。应引入一个局部变量，代替其完成相关操作

实际参数和形式参数做到相匹配：

- 名称上，形式参数和实际参数相互呼应，在名字上就能看出它们是相互对应的
- 类型上，形式参数和实际参数保持一致，整型对整形、浮点对浮点

## 函数的一般编写顺序

1. 函数的定义
2. 参数列表的布局参照了5.1.4类和子程序中提到的方式
3. 文档字符串
4. 实现过程

```python
def function_name( #第一行不放参数
		var_1,
		var_2,
		var_3,
		var_4
		):
	''' 文档字符串 对于多行的情况详见4.2类的一般编写顺序。'''
	print (var_1, var_2, var_3, var_4)
```

# 类的规范

课题组所使用的编程语言为Python，Python是一种典型的面向对象编程语言，通过对现实世界建模，开发者可以利用构建出的一系列对象以及它们之间的相关操作和数据传递以完成任务，这一点体现了具体的编程方法中就是类的使用。规范好类的使用，可以帮助我们尽可能地利用好Python语言的面向对象特性，并有效地降低代码项目的复杂度，方便后期的修改以及代码复用等。好的类应该遵循好的抽象性、好的封装性和足够凝练等几个方面。

## 类规范的基本原则### 抽象性

类是建立在语句、子程序等之上的更高层次的抽象[@martinDaiMaZheng2010]，借助类我们可以完成更好的抽象，这种抽象代表我们可以在一定层次上去考虑现实问题，而不应该被底层的具体实现所困扰，体现在具体的编程过程中就是：创建出一个类以后，类的抽象性使其分离为“接口”和“实现”两部分——“接口”是类和外部程序交互的部分（一般是一堆方法的集合），而“实现”则是我们在写好就无需再多去考虑的细节。

其抽象性应该能做到以下几点：

- 一致且层次一致的抽象，每一个类只专注于实现一种而不是多种抽象数据类型。
- 提供成对的服务，有开始，就有收尾。
- 理解所实现的是哪种抽象，不要把不必要的包含进来。
- 没有很多不相关的信息被使用，如果有需要考虑将这一部分拆成别的类
- 足够短小，可以用一句话描述出来

### 封装性

封装是对细节的隐藏，是迫使我们不能看到背后的细节或实现过程，封装和抽象也有紧密的联系，对于好的类，抽象性和封装性是同时兼具的。从调用者或者使用者的视角来看，如果封装得好，他应该对接口背后的实现细节一无所知，也不会试图去调用背后的数据或实现过程来完成某个过程。

- 封装不好而暴露出来的成分将破坏抽象的一致性，要尽可能限制其可访问性
- 不暴露成员数据
- 隐藏实现细节，不要将其放入接口
- 使用类时没有做任何假设
- 语法和语义都要做到封装：语法封装只是用一些关键字或者编程语言的限定方式去隐藏细节，而语义的封装性则是在使用类时几乎不需要去查看类的内部实现，只做针对接口的编程，

### 凝练

类包含了数据和方法，但并不是说包含得越多越好，出现这种情况可能就反映出了抽象得不够好的问题。好的类应该是足够短小，它所负责的功能足够集中和单一，而不是那种无所不能的类

同时，类中的成分要尽可能得少，它对外界的调用也应该尽可能地少，因为包含或调用的子程序越多越容易出错。数据成员超过7个时应该保持警惕，考虑是不是需要分解

尽量使用包含的关系而不是继承，因为继承会增加代码的复杂度。

## Python类的编写要点和一般顺序

虽然python中没有强制要求将成员数据或方法设置为私有、公用或保护——都是公有的，但是类似的思想同样也得到了强调[@anayaBianXieZheng2022]：

- 类应该只暴露和外部调用者对象相关的属性和方法
- 内部的方法和属性太多，可能是没有做到良好的抽象一致性，承担的责任太多了，
- 用单个下划线开头界定对象接口（但是属性和方法是没有办法设为私有的）
- 类越小越好，负责的功能专一
- 接口越小越好

一般顺序：

1. 文档字符串
2. 初始化函数
	1. 公开数据属性
	2. 非公开数据属性
3. 公开方法
4. 非公开方法
5. （方法不一定要写在类里边）

```python
class Class_name(Object) #Object是构建类时需要继承的基类，可以默认不写
	'''有关类的文档字符串，第一行为简短摘要。
		
	如果是多行第二行需要有空行
	第二行注释
	...
	'''
	def __init__(self, arg1, arg2, ...)
		self.arg1 = arg1
		self._arg2 = arg2
		
	def func1(self)
		print("the class name is {}.".format(self))
```

注意：

- 始终使用 `self` 作为实例方法的第一个参数。
- 始终使用 `cls` 作为类方法的第一个参数。

## 应该避免使用的类

一个好的类应该做到好的抽象，一些不好的类往往是在“抽象”上做得不好，应该避免以下这些：

- 万能的类：这种类所做到的抽象不够集中，导致其内包含的功能太多，看上去能做的事情非常多，然而这样并不有利于实现良好的抽象，也会阻碍正常的代码复用——考虑将其按功能拆分，拆分出的类应该能用简短的一句话描述其功能。
- 只有数据的类：良好的抽象是表示出一个事物及其和事物相关操作的集合，只有数据不能称作是类——只有一堆数据应该考虑将其纳入其他类中的成员数据部分
- 只有操作的类：同样的，没有数据也不能构成一个良好的抽象——考虑将其变成一个子程序

# 布局规范

相比代码本身的质量而言，布局风格注重的大多是美观性的方面，不同的布局风格对于代码的执行效果没有什么差异，但是可以很大地影响到对代码的阅读和理解，有必要按照统一的规范对代码的风格布局进行约束。类似于写作时需要注重书的章节和段落等结构一样，代码布局的总体要求是突出代码本身的逻辑结构，代码布局技术主要涉及空白和缩进的运用。好的代码布局大致有以下几个特点：

- 凸显逻辑结构
- 普适性强
- 修改代码带来的影响尽可能小
- 每行只干一件事

需要强调的另一点是，在Python中，缩进关系到了语法的解读，因此需要格外注意。

## 布局规范的基本原则

### 使用空白和括号的注意事项

空白用于展现结构和增强可读性：

- 空行划分结构。用空行将语句划分成相关的语句组（尤其那些在执行中没有特定顺序要求的语句），相关的语句堆在一起
- 缩进表示从属关系。缩进需要统一规定标准量，涉及到控制结构、折行、子程序参数排布等的缩进都要按照同一个标准量。
- 用两个空行包围类或顶部函数
- 用一个空行包围类内部的方法定义

即使加上括号并没有影响表达式的执行顺序，但是考虑到可读性，仍然推荐使用括号进行划分。

另外，在Python中，标准缩进量使用4个空格，import导入包时导入组之间用一行空行划分[@PEP8Python]。

### 单语句

关于长度限制参照PEP-8中的要求[@PEP8Python]：

- 最长79个字符
- 没有结构话要求的大块文本（注释等）限定在每行72个字符

对于语句中的表达式，使用空格划分，尤其是在运算符附近，对于连续的多个元素，例如子程序参数、数组等，也用空格区分出它们，这里引用PEP-8中的关于空格使用的规范：

- 行尾不要有多余的空格
- 二元运算符两边要有一个空格，
- 优先级不同的表达式中，在优先级低的运算符旁加空格
- 各种括号周围没有空格
- `,`、`:`、`;` 之前没有空格，除了切片中的充当二元运算符的`:`周围要有相同数量的空格
- 连续几行的赋值运算符不要对齐
- 尾随逗号和括号之间没有空格：`foo = (0,)`

单语句秉承“每行只做一件事的原则”：

- 每行只写一条语句
- 每行只声明一个数据
- Python中每行 `import` 只导入一个包

如果有折行，要让这一行明显看起来就和前一行有联系，而不是单独的语句。

- PEP-8中要求，在 Python 代码中，可以在二元运算符之前或之后换行，只要约定在本地保持一致即可，规定采用二元运算符之前换行，即把运算符放在行的开头。
- 关于续行的缩进方式：规定使用悬挂缩进，函数的第一行不放参数，并使用标准的缩进量区分出它是续行，具体可参考3.4节函数的一般编写顺序。

### 块结构

块结构指的是控制结构中的语句组，一个比较明显的特征是在不同语言中会有相应的关键字或花括号等类似的区分结构用语。而在Python中的控制结构直接使用缩进量表示，缩进的不正确将直接导致语法的错误。鉴于Python的这种特点，块结构的布局规范按照Python的语法要求进行，不需要约定。

### 类和子程序

多个类和子程序使用空行分隔，并按字母顺序排列子程序。

子程序和类的内部的不同部分也使用空行进行分隔，如子程序头部、数据和程序主体，方法定义等，具体划分方法见5.1.1节使用空白和括号的注意事项，或PEP-8规范。

子程序参数的组织方式按3.4节函数的一般编写顺序中的示例进行。

## 典型的源文件内容次序安排

1. 模块注释或文档字符串
2. \_\_future\_\_
3. "双下划线"类，例如__all__列表
4. 导入（一行导入一个）
	1. 标准库导入（time、random这种）
	2. 相关第三方导入（numpy、panda这种）
	3. 本地导入（类似自己创建的）
5. 全局变量和具名常量
6. 类定义
7. 函数定义
8. 主程序

## 社区推荐的Python项目结构

如有项目开发的需要，涉及到Python项目的文件结构安排，推荐使用 Pypa 维护的示例项目 中采用的src结构。具体的实施细节参考这篇文章：https://pyloong.github.io/pythonic-project-guidelines/guidelines/project_management/project_structure/#1

# 注释规范

对代码做注释之前有几个大前提：

- 注释值得提倡，但不应滥用
- 好的代码有“自说明”能力，甚至都不需要太多注释去解释
- 不要用注释掩盖质量差的代码，应该考虑重写这段代码
- 注释不要和代码矛盾，这样不如不写
- 注重表达代码表达不出的信息
- 注重层次感，文件头的意图注释等构成高层次注释，类、子程序等相关注释构成低层次注释
- 边开发边写注释

仅提倡以下三种注释：

- 概述型：一两句话总结问题
- 目的型：指出解决的问题而不是解决的方案
- 传达型：代码之外的信息，例如版权声明之类的信息

## 注释规范的基本原则

### 可维护性

有些注释风格只是好看，但是经不起修改，一旦有增删，可能会花大量额外的时间在调整符号等无用的工作上边。不能使用这种风格的注释影响后期的维护

不推荐在不必要的地方作行尾注释同样是出于可维护性这一点，注释空间过小很容易导致注释溢出到第二行。

### 清晰有效

写代码的时候就该考虑到后续工作的方便和与他人的协作，而不是用注释提醒工作中存在疏漏，然后把剩下的烂摊子交给其他人。也不要在代码中写无关的注释。

缩进和注释所在层级的代码保持一致，否则会破坏原有的逻辑结构。每行注释用至少一个空行分割，便于读者从注释中获得对代码的总体认知

避免无效注释：太多的注释不是好事儿，有可能这里面有许多注释并不有效。通过统计数据给出的最佳注释量是每十行语句一条，但这不能作为严格执行的标准，应以注释的质量为重。

不使用简写或缩略语。

PEP-8中要求注释应该是和正常的英文写作一样，如注释使用完整的句子，块注释符合正常的段落规范，句子首字母大写，正常的标点符号等[@PEP8Python]。另外，Python中的文档字符串有一定的格式要求，参考4.2节类的一般编写顺序中给出的示例，

### 问题导向

因为如果代码本身的表达能力足够的话，有许多信息是不需要在注释里重复的，例如好的变量命名，或者是提高抽象层次，加入新的函数或类等。因此注释应该本着解释要解决的问题，使用概述性的解释而不是重复代码所做的事情。好的注释应该是表示出代码的意图而不是操作过程，揭示“为什么做”而不是“怎么做”，使用注释的最佳目的应该是表达出代码本身没有表示出的那些信息。

另外，如果有些做法违背常规，或者是代码中潜在的错误、不特意指出就难以发现的一些点，也是可以用注释指出的。

在Python中，推荐把部分注释的信息放在文档字符串和注解中。

### 参数注释

正如对代码段的注释强调问题和意图等代码表达不出的信息 一样，数据声明的注释应表达出变量名表达不出的信息。

- 数值单位（或者把单位写进变量名）
- 数值的允许范围
- 非数字量的编码含义（1代表开，0代表关）
- 输入数据的限制
- 如果某条注释和变量名有关，应该在注释中写出完整变量名，这样在修改变量名时方便通过查找维护注释
- 全局数据（最好用变量名规范表示全局数据）

### 类和子程序要标注出的信息

由于类和子程序是经过抽象后的一个整体，其中包含多部分的信息，可以按照不同部分进行注释：

- 设计方法：一两句话概述子程序或类。Python中在文档字符串的首行进行说明
- 局限性、接口假设等在使用时可能想不到的或其他暗含的信息。Python中可以在文档字符串的后续行进行说明
	- 注释接口假设
	- 子程序的局限性
	- 子程序的全局效果：对全局数据的修改要说明清楚
	- 所使用算法的来源：标记参考出处
- 数据或参数：声明参数处作有关参数的注释，并适当地分出输入和输出，详见6.1.4节参数注释。Python中使用注解的方式进行说明
- 程序主体或语句组的概括性注释按需给出，特殊点的注释按需给出

使用规范详见4.2节Python类的编写要点和一般编写顺序和6.2节文档字符串和注解。

另外，类接口的注释强调抽象性和封装性，在接口处的注释应该让人不用看实现细节就能明白类如何使用，能拿来直接用，同时不能透漏出实现细节的有关信息，仅写公开使用时需要知道的信息。

### 文件要标注出的信息

文件的注释是更高层次的注释，大致可有以下内容：

- 文件的意图和内容（必需）
- 开发者的联系信息
- 版本控制标记
- 法律通告

## 文档字符串和注解

在Python中，文档字符串是指嵌在源代码中的文档，但它不是注释，这是为代码的特定组件如模块、类或方法等提供的文档。鉴于Python的动态类型特点，如果没有对函数的参数值给予说明，我们很可能不知道应该向其传递什么类型的值。良好的文档字符串对函数的预期输入和输出进行了恰当的说明，推荐在Python中尽可能地添加文档字符串，规范示例见4.2节Python类的编写要点和一般编写顺序。

而注解可以给出所定义变量的期望类型或者其他信息，这些只是向给函数的阅读人员提供信息，对要使用的参数或返回值给予一定的提示，Python不会干涉这些信息。

- 形参的注解方式是在形参名后加`: `
- 返回值的注解方式是在形参列表的括号外和表示函数定义结束的冒号之间加入组合符号`->`

```python
def func(arg1: str, arg2: str) -> str:
	return arg1 + "and" + arg2
```
